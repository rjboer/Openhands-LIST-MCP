# .github/workflows/slsa-go.yml
name: SLSA Go releaser

on:
  release:
    types: [created]              # tag or “Publish release”
  workflow_dispatch:              # manual button

permissions:
  contents: write                 # upload release assets
  id-token: write                 # sign provenance
  actions: read                   # read other workflows

# ──────────────────────────────────────────────────────────────
# 1  Official SLSA-signed build (runs in both triggers)
# ──────────────────────────────────────────────────────────────
jobs:
  slsa-build:
    uses: slsa-framework/slsa-github-generator/.github/workflows/builder_go_slsa3.yml@v2.1.0
    permissions:
      contents: write
      id-token: write
      actions: read
    with:
      go-version: 1.22
      config-file: .slsa-goreleaser.yml   # must be in repo root

# ──────────────────────────────────────────────────────────────
# 2  Manual-run artefact upload (skipped on release)
# ──────────────────────────────────────────────────────────────
  upload-manual:
    if: github.event_name == 'workflow_dispatch'   # only when run manually
    needs: slsa-build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: 1.22
          cache: false

      - name: Build static binary
        env:
          CGO_ENABLED: 0
        run: |
          go env -w CGO_ENABLED=0
          go build -trimpath -ldflags="-s -w" -o Openhands-LIST-MCP ./      # adjust path if main.go is elsewhere

      - name: Upload artefact
        uses: actions/upload-artifact@v4
        with:
          name: Openhands-LIST-MCP_linux_amd64
          path: Openhands-LIST-MCP
