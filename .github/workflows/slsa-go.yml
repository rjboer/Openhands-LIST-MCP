# .github/workflows/slsa-go.yml
# ======================================================================
# Build & release Openhands-LIST-MCP
#   •  Tag / “Publish Release”  → SLSA-signed binary + provenance uploaded to the Release
#   •  Manual “Run workflow”    → same files uploaded as workflow artefacts
# ======================================================================

name: SLSA Go releaser

on:
  release:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write        # create / update releases
  id-token: write        # SLSA provenance signing
  actions: read

jobs:
# ────────────────────────────────────────────────────────────────────
# 1.  SLSA-signed build (runs for both triggers)
# ────────────────────────────────────────────────────────────────────
  slsa-build:
    uses: slsa-framework/slsa-github-generator/.github/workflows/builder_go_slsa3.yml@v2.1.0
    permissions:
      contents: write
      id-token: write
      actions: read
    with:
      go-version: 1.22
      config-file: .slsa-goreleaser.yml           # must be at repo root

# ────────────────────────────────────────────────────────────────────
# 2A.  Upload to Release  (only when event == release)
# ────────────────────────────────────────────────────────────────────
  upload-release-assets:
    if: github.event_name == 'release'
    needs: slsa-build
    runs-on: ubuntu-latest
    steps:
      - name: Download SLSA artefacts produced by previous job
        # Builder places files under ./artifacts relative to root of repository in the runner’s workspace
        run: |
          ls -R
          echo "Nothing to download: artefacts are already in workspace"

      - name: Attach binary
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: artifacts/Openhands-LIST-MCP_linux_amd64
          asset_name: Openhands-LIST-MCP_linux_amd64
          asset_content_type: application/octet-stream

      - name: Attach provenance
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: artifacts/Openhands-LIST-MCP_linux_amd64.intoto.jsonl
          asset_name: Openhands-LIST-MCP_linux_amd64.intoto.jsonl
          asset_content_type: application/json

# ────────────────────────────────────────────────────────────────────
# 2B.  Upload as workflow artefact (manual button runs only)
# ────────────────────────────────────────────────────────────────────
  upload-manual-artifact:
    if: github.event_name == 'workflow_dispatch'
    needs: slsa-build
    runs-on: ubuntu-latest
    steps:
      - name: Upload binary + provenance as artefacts
        uses: actions/upload-artifact@v4
        with:
          name: Openhands-LIST-MCP-output
          path: |
            artifacts/Openhands-LIST-MCP_linux_amd64
            artifacts/Openhands-LIST-MCP_linux_amd64.intoto.jsonl
